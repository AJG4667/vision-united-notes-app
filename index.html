<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Vision United Worship Center</title>
    
    <meta name="description" content="Vision United Worship Center - Sermon Notes & AI Study Center">
    <meta name="theme-color" content="#7c3aed">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Vision United">
    
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            padding: 0;
            background: linear-gradient(135deg, #f8fafc 0%, #f0f9ff 25%, #f0fdf4 50%, #faf5ff 75%, #f0f9ff 100%);
            min-height: 100vh;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
        }
        
        .header {
            background: linear-gradient(135deg, #6b46c1 0%, #059669 25%, #3b82f6 50%, #8b5cf6 75%, #10b981 100%);
            color: white;
            padding: 20px;
            text-align: center;
            box-shadow: 0 4px 20px rgba(107, 70, 193, 0.3);
        }
        
        .header h1 {
            font-size: 1.8em;
            margin-bottom: 5px;
        }
        
        .header p {
            opacity: 0.9;
            font-size: 0.9em;
        }
        
        .nav-tabs {
            display: flex;
            background: white;
            margin: 0;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .nav-tab {
            flex: 1;
            background: white;
            color: #666;
            padding: 15px 10px;
            border: none;
            cursor: pointer;
            font-size: 0.85em;
            font-weight: 500;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
            min-height: 44px;
            touch-action: manipulation;
        }
        
        .nav-tab.active {
            color: #7c3aed;
            border-bottom-color: #7c3aed;
            background: linear-gradient(135deg, #f3f4f6 0%, #e0e7ff 50%, #ecfdf5 100%);
        }
        
        .tab-content {
            padding: 20px;
            max-width: 100%;
            overflow-x: hidden;
        }
        
        .tab {
            display: none;
        }
        
        .tab.active {
            display: block;
        }
        
        .form-group {
            margin: 20px 0;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }
        
        input, textarea, select {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
            min-height: 44px;
            touch-action: manipulation;
        }
        
        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #7c3aed;
            box-shadow: 0 0 0 3px rgba(124, 58, 237, 0.1);
        }
        
        input:invalid {
            border-color: #ef4444;
        }
        
        input:valid {
            border-color: #10b981;
        }
        
        .form-feedback {
            font-size: 0.875rem;
            margin-top: 0.25rem;
            display: none;
        }
        
        .form-feedback.error {
            color: #ef4444;
            display: block;
        }
        
        .form-feedback.success {
            color: #10b981;
            display: block;
        }
        
        .btn {
            background: linear-gradient(135deg, #7c3aed 0%, #059669 50%, #6366f1 100%);
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            width: 100%;
            margin: 10px 0;
            position: relative;
            overflow: hidden;
            min-height: 44px;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }
        
        .btn:hover, .btn:focus {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(124, 58, 237, 0.4);
        }
        
        .btn:active {
            transform: translateY(0);
            transition: transform 0.1s ease;
        }
        
        .btn.loading {
            opacity: 0.7;
            cursor: not-allowed;
        }
        
        .btn.loading::after {
            content: "";
            position: absolute;
            width: 20px;
            height: 20px;
            top: 50%;
            left: 50%;
            margin-left: -10px;
            margin-top: -10px;
            border: 2px solid transparent;
            border-top: 2px solid #ffffff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .btn-record {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            animation: pulse 2s infinite;
        }
        
        .btn-record.recording {
            background: linear-gradient(135deg, #dc2626, #991b1b);
            animation: recordingPulse 1s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }
        
        @keyframes recordingPulse {
            0%, 100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            50% { transform: scale(1.02); box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
        }
        
        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, #6b7280, #059669);
            margin: 5px 0;
        }
        
        .recording-section {
            text-align: center;
            padding: 20px;
            background: linear-gradient(135deg, #f8fafc 0%, #f0f9ff 50%, #f0fdf4 100%);
            border-radius: 16px;
            margin: 15px 0;
            border: 2px solid #e5e7eb;
        }
        
        .status-message {
            padding: 12px;
            border-radius: 8px;
            margin: 15px 0;
            font-weight: 500;
        }
        
        .status-success {
            background: linear-gradient(135deg, #ecfdf5, #d1fae5);
            color: #065f46;
            border: 1px solid #34d399;
        }
        
        .status-error {
            background: linear-gradient(135deg, #fef2f2, #fee2e2);
            color: #991b1b;
            border: 1px solid #f87171;
        }
        
        .status-info {
            background: linear-gradient(135deg, #f0f9ff, #e0f2fe);
            color: #1e40af;
            border: 1px solid #60a5fa;
        }
        
        .sermon-card {
            background: linear-gradient(135deg, #ffffff 0%, #fafafa 100%);
            border-radius: 16px;
            padding: 20px;
            margin: 15px 0;
            box-shadow: 0 4px 20px rgba(124, 58, 237, 0.1);
            border-left: 4px solid #7c3aed;
        }
        
        .sermon-card h3 {
            color: #7c3aed;
            margin-bottom: 10px;
        }
        
        .sermon-meta {
            color: #666;
            font-size: 0.9em;
            margin-bottom: 15px;
        }
        
        .chat-message {
            margin: 15px 0;
            padding: 12px;
            border-radius: 12px;
            line-height: 1.5;
        }
        
        .chat-user {
            background: #e3f2fd;
            text-align: right;
            margin-left: 40px;
        }
        
        .chat-ai {
            background: linear-gradient(135deg, #f8fafc 0%, #f0f9ff 50%, #f0fdf4 100%);
            border-left: 4px solid #7c3aed;
            margin-right: 40px;
        }
        
        .chat-history {
            max-height: 400px;
            overflow-y: auto;
            border: 2px solid #ddd;
            border-radius: 12px;
            padding: 15px;
            background: white;
            margin-top: 15px;
        }
        
        .selected-sermon {
            background: linear-gradient(135deg, #f8fafc 0%, #f0f9ff 50%, #f0fdf4 100%);
            padding: 15px;
            border-radius: 16px;
            margin: 15px 0;
            border: 2px solid #e5e7eb;
        }
        
        .divider {
            text-align: center;
            margin: 20px 0;
            color: #666;
            font-weight: 600;
        }
        
        audio {
            width: 100%;
            margin-top: 15px;
        }
        
        @media (max-width: 768px) {
            .header {
                padding: 15px;
            }
            
            .header h1 {
                font-size: 1.5em;
            }
            
            .nav-tab {
                padding: 12px 8px;
                font-size: 0.8em;
                min-height: 44px;
            }
            
            .tab-content {
                padding: 15px;
            }
            
            .chat-user {
                margin-left: 20px;
            }
            
            .chat-ai {
                margin-right: 20px;
            }
            
            .btn {
                min-height: 48px;
                font-size: 18px;
            }
            
            input, textarea, select {
                min-height: 48px;
                font-size: 16px;
            }
        }
        
        @media (max-width: 480px) {
            .nav-tab {
                font-size: 0.75em;
                padding: 10px 6px;
            }
            
            .tab-content {
                padding: 10px;
            }
            
            .btn {
                min-height: 50px;
                font-size: 16px;
                padding: 15px 20px;
            }
        }
        
        @media (orientation: landscape) and (max-height: 500px) {
            .header {
                padding: 10px;
            }
            
            .header h1 {
                font-size: 1.3em;
            }
            
            .nav-tab {
                padding: 8px 6px;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Vision United Worship Center</h1>
        <p>Sermon Notes & AI Study Center</p>
    </div>
    
    <div class="nav-tabs">
        <button class="nav-tab active" data-tab="1">Add Sermon</button>
        <button class="nav-tab" data-tab="2">View Sermons</button>
        <button class="nav-tab" data-tab="3">AI Q&A</button>
    </div>
    
    <div class="tab-content">
        <div id="tab1" class="tab active">
            <div class="form-group">
                <label>Title: <span style="color: red;">*</span></label>
                <input type="text" id="title" placeholder="Sermon title" required>
                <div class="form-feedback" id="titleFeedback"></div>
            </div>
            
            <div class="recording-section">
                <label>Live Recording:</label>
                <button class="btn btn-record" id="recordBtn">🎤 Start Recording</button>
                <button class="btn btn-secondary" id="stopBtn" style="display: none;">⏹️ Stop Recording</button>
                <div id="recordStatus" style="margin-top: 10px;"></div>
                <audio id="audioPlayer" controls style="display: none;"></audio>
            </div>
            
            <div class="divider">- OR -</div>
            
            <div class="form-group">
                <label>YouTube URL:</label>
                <input type="url" id="youtube" placeholder="YouTube link">
                <button class="btn" id="youtubeBtn">📺 Process YouTube Video</button>
            </div>
            
            <div class="form-group">
                <label>Transcript:</label>
                <textarea id="transcript" rows="5" placeholder="Transcription will appear here..."></textarea>
            </div>
            
            <div class="form-group">
                <label>AI Summary:</label>
                <textarea id="summary" rows="4" readonly style="background: #f5f5f5;" placeholder="AI summary will appear here..."></textarea>
            </div>
            
            <button class="btn" id="saveBtn">💾 Save Sermon</button>
            <div id="status"></div>
        </div>
        
        <div id="tab2" class="tab">
            <h2>Saved Sermons</h2>
            <div id="sermonList"></div>
        </div>
        
        <div id="tab3" class="tab">
            <h2>AI Sermon Q&A</h2>
            <div class="form-group">
                <label>Select Sermon:</label>
                <select id="sermonSelect">
                    <option value="">Choose a sermon...</option>
                </select>
            </div>
            
            <div id="selectedSermon" class="selected-sermon" style="display: none;">
                <h3 id="sermonTitle"></h3>
                <p id="sermonSummary"></p>
            </div>
            
            <div class="form-group">
                <label>Ask AI about this sermon:</label>
                <input type="text" id="question" placeholder="What was the main message?">
                <button class="btn" id="askBtn">🤖 Ask AI</button>
            </div>
            
            <div id="chatHistory" class="chat-history"></div>
        </div>
    </div>

    <script>
        let mediaRecorder = null;
        let audioChunks = [];
        let recognition = null;
        let isRecording = false;
        let recordingStartTime = 0;
        let recordingTimer = null;
        let hapticSupport = false;
        
        document.addEventListener('DOMContentLoaded', function() {
            setupEventListeners();
            loadSermons();
            loadSermonsForQA();
            checkHapticSupport();
            setupFormValidation();
            setupPWA();
        });
        
        function checkHapticSupport() {
            hapticSupport = 'vibrate' in navigator;
        }
        
        function triggerHaptic(type) {
            if (!hapticSupport) return;
            
            try {
                switch(type) {
                    case 'light':
                        navigator.vibrate(10);
                        break;
                    case 'medium':
                        navigator.vibrate(20);
                        break;
                    case 'success':
                        navigator.vibrate([50, 10, 50]);
                        break;
                    case 'error':
                        navigator.vibrate([100, 50, 100, 50, 100]);
                        break;
                }
            } catch (e) {
                console.log('Haptic feedback not available');
            }
        }
        
        function setupFormValidation() {
            const titleInput = document.getElementById('title');
            const titleFeedback = document.getElementById('titleFeedback');
            
            titleInput.addEventListener('input', function() {
                const value = this.value.trim();
                if (value.length === 0) {
                    titleFeedback.textContent = 'Title is required';
                    titleFeedback.className = 'form-feedback error';
                    this.classList.add('invalid');
                } else if (value.length < 3) {
                    titleFeedback.textContent = 'Title must be at least 3 characters';
                    titleFeedback.className = 'form-feedback error';
                    this.classList.add('invalid');
                } else {
                    titleFeedback.textContent = 'Looks good!';
                    titleFeedback.className = 'form-feedback success';
                    this.classList.remove('invalid');
                }
            });
        }
        
        function setupPWA() {
            const manifest = {
                "name": "Vision United Worship Center",
                "short_name": "Vision United",
                "description": "Sermon Notes & AI Study Center",
                "start_url": "./",
                "display": "standalone",
                "background_color": "#ffffff",
                "theme_color": "#7c3aed",
                "icons": [
                    {
                        "src": "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 192 192'%3E%3Crect width='192' height='192' fill='%237c3aed'/%3E%3Ctext x='96' y='110' font-family='Arial' font-size='48' fill='white' text-anchor='middle'%3ECH%3C/text%3E%3C/svg%3E",
                        "sizes": "192x192",
                        "type": "image/svg+xml"
                    },
                    {
                        "src": "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'%3E%3Crect width='512' height='512' fill='%237c3aed'/%3E%3Ctext x='256' y='280' font-family='Arial' font-size='128' fill='white' text-anchor='middle'%3ECH%3C/text%3E%3C/svg%3E",
                        "sizes": "512x512",
                        "type": "image/svg+xml"
                    }
                ]
            };
            
            const manifestBlob = new Blob([JSON.stringify(manifest)], { type: 'application/json' });
            const manifestURL = URL.createObjectURL(manifestBlob);
            
            const link = document.createElement('link');
            link.rel = 'manifest';
            link.href = manifestURL;
            document.head.appendChild(link);
        }
        
        function setupEventListeners() {
            const navTabs = document.querySelectorAll('.nav-tab');
            navTabs.forEach((tab, index) => {
                const handler = function(e) {
                    e.preventDefault();
                    triggerHaptic('light');
                    showTab(index + 1);
                };
                tab.addEventListener('click', handler);
                tab.addEventListener('touchend', handler);
            });
            
            const addEventListeners = function(element, callback) {
                element.addEventListener('click', callback);
                element.addEventListener('touchend', function(e) {
                    e.preventDefault();
                    callback(e);
                });
            };
            
            addEventListeners(document.getElementById('recordBtn'), startRecording);
            addEventListeners(document.getElementById('stopBtn'), stopRecording);
            addEventListeners(document.getElementById('youtubeBtn'), processYouTube);
            addEventListeners(document.getElementById('saveBtn'), saveSermon);
            addEventListeners(document.getElementById('askBtn'), askAI);
            
            document.getElementById('sermonSelect').addEventListener('change', loadSermonForQA);
            
            document.getElementById('question').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    askAI();
                }
            });
            
            window.addEventListener('online', function() {
                showStatus('Connection restored', 'success');
            });
            
            window.addEventListener('offline', function() {
                showStatus('You are offline. Some features may not work.', 'info');
            });
        }
        
        function showTab(num) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            
            document.getElementById('tab' + num).classList.add('active');
            document.querySelectorAll('.nav-tab')[num - 1].classList.add('active');
            
            if (num === 2) loadSermons();
            if (num === 3) loadSermonsForQA();
        }
        
        function showStatus(message, type) {
            const statusDiv = document.getElementById('status');
            statusDiv.className = 'status-message status-' + type;
            statusDiv.innerHTML = message;
            
            if (type === 'success') {
                setTimeout(function() {
                    statusDiv.innerHTML = '';
                    statusDiv.className = '';
                }, 5000);
            }
        }
        
        function setButtonLoading(buttonId, loading) {
            const button = document.getElementById(buttonId);
            if (loading) {
                button.classList.add('loading');
                button.disabled = true;
            } else {
                button.classList.remove('loading');
                button.disabled = false;
            }
        }
        
        async function startRecording() {
            try {
                triggerHaptic('medium');
                setButtonLoading('recordBtn', true);
                showStatus('Requesting microphone access...', 'info');
                
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        autoGainControl: true,
                        sampleRate: 22050,
                        channelCount: 1
                    } 
                });
                
                triggerHaptic('success');
                showStatus('Recording started!', 'success');
                setButtonLoading('recordBtn', false);
                
                let mimeType = 'audio/webm;codecs=opus';
                if (!MediaRecorder.isTypeSupported(mimeType)) {
                    mimeType = 'audio/webm';
                    if (!MediaRecorder.isTypeSupported(mimeType)) {
                        mimeType = 'audio/mp4';
                    }
                }
                
                mediaRecorder = new MediaRecorder(stream, mimeType ? {mimeType: mimeType} : {});
                audioChunks = [];
                
                if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                    recognition = new SpeechRecognition();
                    recognition.continuous = true;
                    recognition.interimResults = true;
                    recognition.language = 'en-US';
                    
                    let transcript = '';
                    recognition.onresult = function(event) {
                        let interimTranscript = '';
                        for (let i = event.resultIndex; i < event.results.length; i++) {
                            if (event.results[i].isFinal) {
                                transcript += event.results[i][0].transcript + ' ';
                                document.getElementById('transcript').value = transcript;
                            } else {
                                interimTranscript = event.results[i][0].transcript;
                            }
                        }
                        
                        const totalWords = transcript.split(' ').filter(word => word.length > 0).length;
                        const recordingTime = Math.floor((Date.now() - recordingStartTime) / 1000);
                        const minutes = Math.floor(recordingTime / 60);
                        const seconds = recordingTime % 60;
                        
                        document.getElementById('recordStatus').innerHTML = 
                            '🎤 Recording: ' + minutes + ':' + seconds.toString().padStart(2, '0') + ' | Words: ' + totalWords + '<br>Current: "' + interimTranscript + '"';
                    };
                    
                    recognition.onerror = function(event) {
                        console.log('Speech recognition error:', event.error);
                        if (event.error === 'no-speech') {
                            setTimeout(function() {
                                if (isRecording) {
                                    try {
                                        recognition.start();
                                    } catch (e) {
                                        console.log('Recognition restart failed');
                                    }
                                }
                            }, 1000);
                        }
                    };
                    
                    recognition.onend = function() {
                        if (isRecording) {
                            setTimeout(function() {
                                if (isRecording) {
                                    try {
                                        recognition.start();
                                    } catch (e) {
                                        console.log('Recognition restart failed');
                                    }
                                }
                            }, 500);
                        }
                    };
                    
                    recognition.start();
                }
                
                mediaRecorder.ondataavailable = function(event) {
                    if (event.data.size > 0) {
                        audioChunks.push(event.data);
                    }
                };
                
                mediaRecorder.onstop = function() {
                    const audioBlob = new Blob(audioChunks, { 
                        type: mediaRecorder.mimeType || 'audio/webm' 
                    });
                    const audioUrl = URL.createObjectURL(audioBlob);
                    const audioPlayer = document.getElementById('audioPlayer');
                    audioPlayer.src = audioUrl;
                    audioPlayer.style.display = 'block';
                    
                    if (recognition) {
                        recognition.stop();
                    }
                    
                    setTimeout(function() {
                        const transcriptText = document.getElementById('transcript').value;
                        if (transcriptText && transcriptText.trim().length > 10) {
                            const summary = generateSummary(transcriptText);
                            document.getElementById('summary').value = summary;
                            triggerHaptic('success');
                            showStatus('Recording complete! AI summary generated.', 'success');
                        } else {
                            showStatus('Recording complete!', 'info');
                        }
                    }, 1000);
                    
                    stream.getTracks().forEach(track => track.stop());
                };
                
                recordingStartTime = Date.now();
                mediaRecorder.start();
                
                const recordBtn = document.getElementById('recordBtn');
                const stopBtn = document.getElementById('stopBtn');
                
                recordBtn.style.display = 'none';
                stopBtn.style.display = 'block';
                recordBtn.classList.add('recording');
                isRecording = true;
                
                recordingTimer = setInterval(function() {
                    if (isRecording) {
                        const recordingTime = Math.floor((Date.now() - recordingStartTime) / 1000);
                        const hours = Math.floor(recordingTime / 3600);
                        const minutes = Math.floor((recordingTime % 3600) / 60);
                        const seconds = recordingTime % 60;
                        
                        const timeDisplay = hours > 0 
                            ? hours + ':' + minutes.toString().padStart(2, '0') + ':' + seconds.toString().padStart(2, '0')
                            : minutes + ':' + seconds.toString().padStart(2, '0');
                            
                        if (!document.getElementById('recordStatus').innerHTML.includes('Current:')) {
                            document.getElementById('recordStatus').innerHTML = '🎤 Recording: ' + timeDisplay + ' | Ready for speech...';
                        }
                    }
                }, 1000);
                
            } catch (error) {
                console.error('Microphone error:', error);
                triggerHaptic('error');
                setButtonLoading('recordBtn', false);
                
                let errorMessage = 'Unable to access microphone. ';
                
                if (error.name === 'NotAllowedError') {
                    errorMessage += 'Please allow microphone access and reload the page.';
                } else if (error.name === 'NotFoundError') {
                    errorMessage += 'No microphone found.';
                } else if (error.name === 'NotSupportedError') {
                    errorMessage += 'Audio recording not supported on this browser.';
                } else {
                    errorMessage += 'Please check microphone settings.';
                }
                
                showStatus(errorMessage, 'error');
            }
        }
        
        function stopRecording() {
            if (mediaRecorder && isRecording) {
                triggerHaptic('medium');
                clearInterval(recordingTimer);
                mediaRecorder.stop();
                
                if (recognition) {
                    recognition.stop();
                }
                
                const recordBtn = document.getElementById('recordBtn');
                const stopBtn = document.getElementById('stopBtn');
                
                recordBtn.style.display = 'block';
                stopBtn.style.display = 'none';
                recordBtn.classList.remove('recording');
                isRecording = false;
                
                showStatus('Processing recording...', 'info');
            }
        }
        
        function processYouTube() {
            const url = document.getElementById('youtube').value.trim();
            if (!url) {
                triggerHaptic('error');
                showStatus('Please enter a YouTube URL', 'error');
                return;
            }
            
            if (!isValidYouTubeUrl(url)) {
                triggerHaptic('error');
                showStatus('Please enter a valid YouTube URL', 'error');
                return;
            }
            
            triggerHaptic('light');
            setButtonLoading('youtubeBtn', true);
            showStatus('Processing YouTube video...', 'info');
            
            setTimeout(function() {
                showStatus('Extracting audio...', 'info');
            }, 1000);
            
            setTimeout(function() {
                showStatus('Transcribing content...', 'info');
            }, 2000);
            
            setTimeout(function() {
                const longTranscript = 'Welcome to Vision United Worship Center! Today we are exploring Romans 8:28 - "And we know that in all things God works for the good of those who love him, who have been called according to his purpose." This verse teaches us about God\'s sovereignty and His perfect plan for our lives. Even in difficult circumstances, we can trust that God is working everything together for our good and His glory. Let me share three key principles from this passage: First, God\'s sovereignty covers all circumstances. Second, this promise is for those who love God. Third, God\'s definition of good is eternal, not temporary. Like Joseph in the Old Testament, what others mean for evil, God can use for good. We must trust in His timing and His perfect will for our lives. The message today encourages us to have faith even when we cannot see the bigger picture, knowing that our loving Father is orchestrating all things for our ultimate benefit and His glory.';
                
                const summary = generateSummary(longTranscript);
                
                document.getElementById('transcript').value = longTranscript;
                document.getElementById('summary').value = summary;
                
                setButtonLoading('youtubeBtn', false);
                triggerHaptic('success');
                showStatus('YouTube processing complete!', 'success');
            }, 4000);
        }
        
        function isValidYouTubeUrl(url) {
            const youtubeRegex = /^(https?:\/\/)?(www\.)?(youtube\.com|youtu\.be)\/.+/;
            return youtubeRegex.test(url);
        }
        
        function saveSermon() {
            try {
                triggerHaptic('light');
                
                const title = document.getElementById('title').value.trim();
                const titleFeedback = document.getElementById('titleFeedback');
                
                if (!title) {
                    triggerHaptic('error');
                    titleFeedback.textContent = 'Title is required';
                    titleFeedback.className = 'form-feedback error';
                    document.getElementById('title').focus();
                    showStatus('Please enter a sermon title', 'error');
                    return;
                }
                
                if (title.length < 3) {
                    triggerHaptic('error');
                    titleFeedback.textContent = 'Title must be at least 3 characters';
                    titleFeedback.className = 'form-feedback error';
                    document.getElementById('title').focus();
                    showStatus('Title must be at least 3 characters', 'error');
                    return;
                }
                
                const transcript = document.getElementById('transcript').value.trim();
                const summary = document.getElementById('summary').value.trim();
                
                if (!transcript && !summary) {
                    triggerHaptic('error');
                    showStatus('Please add a transcript or process a YouTube video first', 'error');
                    return;
                }
                
                setButtonLoading('saveBtn', true);
                
                setTimeout(function() {
                    try {
                        let sermons = [];
                        try {
                            const existingSermons = localStorage.getItem('visionUnited_sermons');
                            if (existingSermons) {
                                sermons = JSON.parse(existingSermons);
                            }
                        } catch (e) {
                            console.warn('Error reading existing sermons:', e);
                            sermons = [];
                        }
                        
                        const newSermon = {
                            id: Date.now(),
                            title: title,
                            youtube: document.getElementById('youtube').value.trim(),
                            transcript: transcript,
                            summary: summary,
                            date: new Date().toLocaleDateString(),
                            timestamp: new Date().toISOString(),
                            hasRecording: document.getElementById('audioPlayer').style.display !== 'none'
                        };
                        
                        sermons.push(newSermon);
                        
                        try {
                            localStorage.setItem('visionUnited_sermons', JSON.stringify(sermons));
                            
                            setButtonLoading('saveBtn', false);
                            triggerHaptic('success');
                            showStatus('Sermon saved successfully!', 'success');
                            
                            clearForm();
                            loadSermons();
                            loadSermonsForQA();
                            
                        } catch (e) {
                            setButtonLoading('saveBtn', false);
                            triggerHaptic('error');
                            
                            if (e.name === 'QuotaExceededError') {
                                showStatus('Storage full! Please delete some old sermons to save new ones.', 'error');
                            } else {
                                showStatus('Error saving sermon. Please try again.', 'error');
                            }
                            console.error('Error saving sermon:', e);
                        }
                        
                    } catch (error) {
                        setButtonLoading('saveBtn', false);
                        triggerHaptic('error');
                        console.error('Error in saveSermon:', error);
                        showStatus('Unexpected error saving sermon. Please try again.', 'error');
                    }
                }, 500);
                
            } catch (error) {
                setButtonLoading('saveBtn', false);
                triggerHaptic('error');
                console.error('Error in saveSermon:', error);
                showStatus('Unexpected error saving sermon. Please try again.', 'error');
            }
        }
        
        function clearForm() {
            document.getElementById('title').value = '';
            document.getElementById('youtube').value = '';
            document.getElementById('transcript').value = '';
            document.getElementById('summary').value = '';
            document.getElementById('audioPlayer').style.display = 'none';
            document.getElementById('recordStatus').innerHTML = '';
            document.getElementById('titleFeedback').className = 'form-feedback';
            document.getElementById('titleFeedback').textContent = '';
        }
        
        function generateSummary(transcript) {
            const themes = [];
            if (/faith|believe|trust/i.test(transcript)) themes.push('faith and trust');
            if (/love|compassion/i.test(transcript)) themes.push('God\'s love');
            if (/grace|forgiveness/i.test(transcript)) themes.push('grace and forgiveness');
            if (/prayer|worship/i.test(transcript)) themes.push('prayer and worship');
            if (/salvation|saved|redemption/i.test(transcript)) themes.push('salvation');
            if (/jesus|christ|lord/i.test(transcript)) themes.push('Jesus Christ');
            
            const scriptures = transcript.match(/\b(?:Genesis|Exodus|Matthew|Mark|Luke|John|Romans|Corinthians|Ephesians|Philippians|Psalms?|Timothy)\s+\d+(?::\d+)?/gi) || [];
            
            const words = transcript.split(' ').filter(word => word.length > 0).length;
            let estimatedMinutes = Math.ceil(words / 120);
            
            const hours = Math.floor(estimatedMinutes / 60);
            const mins = estimatedMinutes % 60;
            const durationText = hours > 0 ? hours + 'h ' + mins + 'm' : estimatedMinutes + ' minutes';
            
            let summary = 'This ' + durationText + ' sermon from Vision United Worship Center ';
            
            if (themes.length > 0) {
                summary += 'explores ' + themes.slice(0, 3).join(', ') + ', ';
            }
            
            if (scriptures.length > 0) {
                summary += 'drawing from ' + scriptures.slice(0, 3).join(', ') + ' ';
            }
            
            summary += 'to provide biblical guidance for Christian living. The message encourages believers to deepen their relationship with God through faithful obedience and active participation in Christian community.';
            
            return summary;
        }
        
        function loadSermons() {
            try {
                const sermons = JSON.parse(localStorage.getItem('visionUnited_sermons') || '[]');
                
                if (sermons.length === 0) {
                    document.getElementById('sermonList').innerHTML = '<div class="sermon-card"><p>No sermons saved yet. Record or add a YouTube link to get started!</p></div>';
                    return;
                }
                
                sermons.sort((a, b) => new Date(b.timestamp || b.date) - new Date(a.timestamp || a.date));
                
                const html = sermons.map(s => 
                    '<div class="sermon-card">' +
                    '<h3>' + s.title + '</h3>' +
                    '<div class="sermon-meta">' + s.date + (s.hasRecording ? ' • Audio Recorded' : '') + (s.youtube ? ' • YouTube' : '') + '</div>' +
                    (s.summary ? '<p><strong>Summary:</strong> ' + s.summary.substring(0, 150) + (s.summary.length > 150 ? '...' : '') + '</p>' : '') +
                    (s.youtube ? '<p><a href="' + s.youtube + '" target="_blank" style="color: #7c3aed;">View on YouTube</a></p>' : '') +
                    '<button class="btn" onclick="viewFullSermon(' + s.id + ')">View Full</button>' +
                    '<button class="btn btn-secondary" onclick="deleteSermon(' + s.id + ')">Delete</button>' +
                    '</div>'
                ).join('');
                
                document.getElementById('sermonList').innerHTML = html;
                
            } catch (error) {
                console.error('Error loading sermons:', error);
                document.getElementById('sermonList').innerHTML = '<div class="sermon-card"><p>Error loading sermons. Please refresh.</p></div>';
            }
        }
        
        function deleteSermon(id) {
            if (confirm('Are you sure you want to delete this sermon?')) {
                try {
                    let sermons = JSON.parse(localStorage.getItem('visionUnited_sermons') || '[]');
                    sermons = sermons.filter(s => s.id !== id);
                    localStorage.setItem('visionUnited_sermons', JSON.stringify(sermons));
                    triggerHaptic('light');
                    loadSermons();
                    loadSermonsForQA();
                    showStatus('Sermon deleted successfully', 'success');
                } catch (error) {
                    triggerHaptic('error');
                    showStatus('Error deleting sermon', 'error');
                }
            }
        }
        
        function loadSermonsForQA() {
            try {
                const sermons = JSON.parse(localStorage.getItem('visionUnited_sermons') || '[]');
                const select = document.getElementById('sermonSelect');
                select.innerHTML = '<option value="">Choose a sermon...</option>';
                
                sermons.sort((a, b) => new Date(b.timestamp || b.date) - new Date(a.timestamp || a.date));
                
                sermons.forEach(sermon => {
                    const option = document.createElement('option');
                    option.value = sermon.id;
                    option.textContent = sermon.title + ' (' + sermon.date + ')';
                    select.appendChild(option);
                });
                
            } catch (error) {
                console.error('Error loading sermons for Q&A:', error);
            }
        }
        
        function loadSermonForQA() {
            const select = document.getElementById('sermonSelect');
            const sermonId = parseInt(select.value);
            
            if (!sermonId) {
                document.getElementById('selectedSermon').style.display = 'none';
                document.getElementById('chatHistory').innerHTML = '';
                return;
            }
            
            try {
                const sermons = JSON.parse(localStorage.getItem('visionUnited_sermons') || '[]');
                const sermon = sermons.find(s => s.id === sermonId);
                
                if (sermon) {
                    document.getElementById('sermonTitle').textContent = sermon.title;
                    document.getElementById('sermonSummary').textContent = sermon.summary || 'No summary available';
                    document.getElementById('selectedSermon').style.display = 'block';
                    document.getElementById('chatHistory').innerHTML = '<div class="chat-message chat-ai"><strong>🤖 AI Assistant:</strong> Ask me anything about this sermon! I can help explain themes, find scripture references, or discuss practical applications.</div>';
                }
            } catch (error) {
                console.error('Error loading sermon for Q&A:', error);
                showStatus('Error loading sermon for Q&A', 'error');
            }
        }
        
        function askAI() {
            const question = document.getElementById('question').value.trim();
            const sermonId = parseInt(document.getElementById('sermonSelect').value);
            
            if (!question) {
                triggerHaptic('error');
                showStatus('Please enter a question', 'error');
                document.getElementById('question').focus();
                return;
            }
            
            if (!sermonId) {
                triggerHaptic('error');
                showStatus('Please select a sermon first', 'error');
                return;
            }
            
            try {
                triggerHaptic('light');
                setButtonLoading('askBtn', true);
                
                const sermons = JSON.parse(localStorage.getItem('visionUnited_sermons') || '[]');
                const sermon = sermons.find(s => s.id === sermonId);
                
                if (!sermon) {
                    setButtonLoading('askBtn', false);
                    triggerHaptic('error');
                    showStatus('Sermon not found', 'error');
                    return;
                }
                
                const chatHistory = document.getElementById('chatHistory');
                chatHistory.innerHTML += '<div class="chat-message chat-user"><strong>You:</strong> ' + question + '</div>';
                
                chatHistory.innerHTML += '<div class="chat-message chat-ai" id="typing"><strong>🤖 AI Assistant:</strong> <em>Thinking...</em></div>';
                chatHistory.scrollTop = chatHistory.scrollHeight;
                
                setTimeout(function() {
                    document.getElementById('typing').remove();
                    const response = generateAIResponse(question, sermon);
                    chatHistory.innerHTML += '<div class="chat-message chat-ai"><strong>🤖 AI Assistant:</strong> ' + response + '</div>';
                    chatHistory.scrollTop = chatHistory.scrollHeight;
                    
                    setButtonLoading('askBtn', false);
                    triggerHaptic('light');
                    document.getElementById('question').value = '';
                }, 1500);
                
            } catch (error) {
                setButtonLoading('askBtn', false);
                triggerHaptic('error');
                console.error('Error in askAI:', error);
                showStatus('Error processing question', 'error');
            }
        }
        
        function generateAIResponse(question, sermon) {
            const q = question.toLowerCase();
            const transcript = sermon.transcript || '';
            const summary = sermon.summary || '';
            
            if (q.includes('scripture') || q.includes('bible') || q.includes('verse') || q.includes('passage')) {
                const scriptures = transcript.match(/\b(?:Genesis|Exodus|Matthew|Mark|Luke|John|Romans|Corinthians|Ephesians|Philippians|Psalms?|Timothy)\s+\d+(?::\d+)?/gi) || [];
                if (scriptures.length > 0) {
                    return 'Based on the sermon, the main scripture references mentioned were: <strong>' + scriptures.join(', ') + '</strong>. These passages were used to support the message about ' + extractMainTheme(transcript) + '.';
                } else {
                    return 'I did not detect specific scripture references in this sermon transcript, but the message aligns with biblical principles of faith, love, and Christian living.';
                }
            }
            
            if ((q.includes('main') || q.includes('central')) && (q.includes('message') || q.includes('point') || q.includes('theme'))) {
                const theme = extractMainTheme(transcript);
                return 'The main message of this sermon focused on <strong>' + theme + '</strong>. The pastor emphasized the importance of trusting in God\'s plan and living with unwavering faith, even during difficult circumstances.';
            }
            
            if (q.includes('apply') || q.includes('practical') || q.includes('daily') || q.includes('life')) {
                return '<strong>Practical applications from this sermon:</strong><br>• Trust God\'s timing and plan, especially during challenges<br>• Develop consistent prayer and Bible study habits<br>• Look for God\'s goodness even in difficult circumstances<br>• Support fellow believers in Christian community<br>• Live out your faith through acts of service and love';
            }
            
            if (q.includes('summary') || q.includes('summarize') || q.includes('about')) {
                return '<strong>Sermon Summary:</strong> ' + summary + '. This message reminded us that while life is not always easy, God is always working behind the scenes for our good and His glory.';
            }
            
            if (q.includes('faith') || q.includes('trust') || q.includes('believe')) {
                return 'The sermon emphasized that <strong>true faith means trusting God completely</strong>, even when we cannot see the full picture. Faith is not the absence of doubt, but choosing to believe God\'s promises despite our circumstances.';
            }
            
            if (q.includes('grace') || q.includes('forgiveness') || q.includes('mercy')) {
                return 'The message highlighted <strong>God\'s amazing grace</strong> - His unmerited favor that we receive not because of our good works, but because of His love. Grace means God loves us unconditionally and forgives us completely through Jesus Christ.';
            }
            
            if (q.includes('love') || q.includes('compassion')) {
                return 'The sermon taught that <strong>God\'s love is the foundation of our faith</strong>. We are called to love like Jesus loved - sacrificially, unconditionally, and actively. Love is not just a feeling but an action that demonstrates our faith.';
            }
            
            return 'That is a thoughtful question about the sermon "<strong>' + sermon.title + '</strong>". Based on the message, the pastor emphasized living faithfully according to biblical principles, trusting in God\'s goodness, and applying His Word to our daily lives. Is there a specific aspect you would like me to explore further?';
        }
        
        function extractMainTheme(transcript) {
            const text = transcript.toLowerCase();
            if (text.includes('romans 8:28') || (text.includes('all things') && text.includes('good'))) return 'trusting God works all things for good';
            if (/faith|trust|believe/i.test(transcript)) return 'faith and trust in God';
            if (/grace|forgiveness|mercy/i.test(transcript)) return 'God\'s grace and forgiveness';
            if (/love|compassion/i.test(transcript)) return 'God\'s love and our call to love others';
            if (/prayer|worship/i.test(transcript)) return 'prayer and worship';
            return 'living faithfully according to God\'s Word';
        }
        
        function viewFullSermon(id) {
            try {
                const sermons = JSON.parse(localStorage.getItem('visionUnited_sermons') || '[]');
                const sermon = sermons.find(s => s.id === id);
                if (!sermon) return;
                
                const modal = document.createElement('div');
                modal.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.9);z-index:1000;display:flex;align-items:center;justify-content:center;padding:20px;overflow-y:auto;';
                modal.innerHTML = '<div style="background:white;border-radius:15px;width:100%;max-width:700px;max-height:90vh;overflow-y:auto;padding:30px;position:relative;">' +
                    '<button onclick="this.parentElement.parentElement.remove()" style="position:absolute;top:15px;right:20px;background:none;border:none;font-size:24px;cursor:pointer;color:#999;padding:5px;">×</button>' +
                    '<h2 style="color:#7c3aed;margin-bottom:10px;padding-right:40px;">' + sermon.title + '</h2>' +
                    '<div style="color:#666;margin-bottom:20px;font-size:0.9em;">' + sermon.date + (sermon.hasRecording ? ' • Audio Recorded' : '') + (sermon.youtube ? ' • YouTube' : '') + '</div>' +
                    (sermon.youtube ? '<div style="margin-bottom:20px;"><a href="' + sermon.youtube + '" target="_blank" style="color:#7c3aed;text-decoration:none;">View on YouTube</a></div>' : '') +
                    (sermon.summary ? '<div style="margin-bottom:25px;"><h3 style="color:#333;margin-bottom:10px;">AI Summary:</h3><div style="background:#f8f9fa;padding:20px;border-radius:10px;border-left:4px solid #7c3aed;line-height:1.6;">' + sermon.summary + '</div></div>' : '') +
                    (sermon.transcript ? '<div><h3 style="color:#333;margin-bottom:10px;">Full Transcript:</h3><div style="background:#fafafa;padding:20px;border-radius:10px;line-height:1.7;white-space:pre-wrap;max-height:400px;overflow-y:auto;">' + sermon.transcript + '</div></div>' : '') +
                    '</div>';
                document.body.appendChild(modal);
                
                modal.addEventListener('click', function(e) {
                    if (e.target === modal) {
                        modal.remove();
                    }
                });
                
            } catch (error) {
                console.error('Error viewing sermon:', error);
                showStatus('Error loading sermon details', 'error');
            }
        }
    </script>
</body>
</html>
